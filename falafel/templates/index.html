<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Analyzer and Trainer</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* ... (previous styles remain the same) ... */
        
        #training-section {
            margin-top: 30px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
        
        #training-logs {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            background-color: #f9f9f9;
        }
        
        #training-progress {
            margin-top: 10px;
            background-color: #ecf0f1;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #progress-bar {
            width: 0;
            height: 100%;
            background-color: #3498db;
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Image Analyzer and Trainer</h1>
        
        <!-- ... (previous form and results sections remain the same) ... -->
        
        <div id="training-section">
            <h2>Model Training</h2>
            <form id="training-form">
                <label for="epochs">Number of Epochs:</label>
                <input type="number" id="epochs" name="epochs" min="1" value="10">
                <button type="submit" id="start-training-btn">Start Training</button>
            </form>
            <button id="stop-training-btn" style="display: none;">Stop Training</button>
            <div id="training-progress">
                <div id="progress-bar"></div>
            </div>
            <div id="training-logs"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        $(document).ready(function() {
            var socket = io();
            var isTraining = false;

            // ... (previous JavaScript for file upload and analysis remains the same) ...

            $('#training-form').on('submit', function(e) {
                e.preventDefault();
                var epochs = $('#epochs').val();
                
                $.ajax({
                    url: '/start_training',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({epochs: epochs}),
                    success: function(response) {
                        console.log(response.message);
                        $('#start-training-btn').hide();
                        $('#stop-training-btn').show();
                        isTraining = true;
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error starting training:', errorThrown);
                    }
                });
            });

            $('#stop-training-btn').on('click', function() {
                $.ajax({
                    url: '/stop_training',
                    type: 'POST',
                    success: function(response) {
                        console.log(response.message);
                        $('#stop-training-btn').hide();
                        $('#start-training-btn').show();
                        isTraining = false;
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error stopping training:', errorThrown);
                    }
                });
            });

            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('training_state', function(data) {
                isTraining = data.is_training;
                updateTrainingUI(data.current_epoch, data.total_epochs);
            });

            socket.on('training_progress', function(data) {
                var logMessage = `Epoch ${data.epoch}/${data.total_epochs} - ` +
                                 `loss: ${data.loss.toFixed(4)} - ` +
                                 `accuracy: ${data.accuracy.toFixed(4)} - ` +
                                 `val_loss: ${data.val_loss.toFixed(4)} - ` +
                                 `val_accuracy: ${data.val_accuracy.toFixed(4)}`;
                $('#training-logs').append(logMessage + '\n');
                $('#training-logs').scrollTop($('#training-logs')[0].scrollHeight);
                
                updateTrainingUI(data.epoch, data.total_epochs);
            });

            socket.on('training_complete', function() {
                $('#training-logs').append('Training complete!\n');
                $('#stop-training-btn').hide();
                $('#start-training-btn').show();
                isTraining = false;
            });

            socket.on('training_error', function(data) {
                $('#training-logs').append('Error during training: ' + data.error + '\n');
                $('#stop-training-btn').hide();
                $('#start-training-btn').show();
                isTraining = false;
            });

            function updateTrainingUI(currentEpoch, totalEpochs) {
                var progress = (currentEpoch / totalEpochs) * 100;
                $('#progress-bar').css('width', progress + '%');
                
                if (isTraining) {
                    $('#start-training-btn').hide();
                    $('#stop-training-btn').show();
                } else {
                    $('#stop-training-btn').hide();
                    $('#start-training-btn').show();
                }
            }

            // Handle page unload
            $(window).on('beforeunload', function() {
                if (isTraining) {
                    return "Training is in progress. Are you sure you want to leave?";
                }
            });
        });
    </script>
</body>
</html>